<!DOCTYPE html>
<html>
    <head>
        <title> notuber </title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <style>
                        html {
                        height: 100%;
                        font-family: Helvetica, "Helvetica Neue", Arial, sans-serif;
                        }

                        body {
                                height: 100%;
                                margin: 0px;
                                padding: 0px;
                        }

                        #myMap {
                                width: 100%;
                                height: 100%;
                        }
        </style>

        <script>
            var xhr = new XMLHttpRequest();
            var uri = "https://defense-in-derpth.herokuapp.com/submit";
            var lat = 0;
            var long = 0;
            var argument;
            var me = new google.maps.LatLng(lat,long);
            var infowindow = new google.maps.InfoWindow();

            var options = {
                                zoom: 10,
                                center: me,
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                          };
            var map;
            var marker;
            var driverList = [];
            var passList = [];

            var response;
            var markerarray = [];

            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4){  
                    console.log("Got it");      
                    response = xhr.responseText;
                    /* Parse into an object */
                    response = JSON.parse(response);
                    /*console.log(response);*/
                    console.log(response);
                    if(response.hasOwnProperty("vehicles"))
                        getVehicles(response);

                    else if(response.hasOwnProperty("passengers")){
                        getPassengers(response);
                    }
                
                else console.log("notready");

                }
            }

            function getVehicles(response)
            {
                    for(var cars in response.vehicles){
                    var newCar = response.vehicles[cars];
                    console.log(newCar.lat + " " + newCar.lng);
                    
                    driverList.push({
                        position: new google.maps.LatLng(newCar.lat, newCar.lng),
                        username: newCar.username
                        });
                }
                var image = "vehicle.png";
                render(driverList,image);
            }

            function getPassengers(response)
            {
                for(var ppl in response.passengers){
                    var newPer = response.passengers[ppl];
                    console.log(newPer.lat + " " + newPer.lng);
                    
                    passList.push({
                        position: new google.maps.LatLng(newPer.lat, newPer.lng),
                        username: newPer.username
                        });
                }
                var image = "passenger.png";
                render(passList,image);
            }
            function init(){
                map = new google.maps.Map(document.getElementById("myMap"),
                    options);
                getLocale();

            }

            function getLocale(){
                if(navigator.geolocation){
                    navigator.geolocation.getCurrentPosition(function(position){
                        lat = position.coords.latitude;
                        long = position.coords.longitude;
                        post();
                        render();
                    })
                }
            }

            function render(list, image){

        for(var i in list){
                marker = new google.maps.Marker({
                        position: list[i].position,
                        title: list[i].username,
                        icon: image,
                        map: map
                })

                google.maps.event.addListener(marker, 'click', 
                        (function(marker, i) {
                        return function() {
                                infowindow.setContent(list[i].username);
                                infowindow.open(map, marker);
                        }
                })(marker, i));
        }


                me = new google.maps.LatLng(lat,long);
                map.panTo(me);
                marker = new google.maps.Marker({
                    position: me,
                    title: "Me!",
                });
                marker.setMap(map);
                google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(marker.title);
					infowindow.open(map, marker);
				});
                
            }
            function post(){
                var username = "i3oxTCVc";
                var argument = "username="+username+"&lat="+lat+"&lng="+long;
                xhr.open('POST', uri, true);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.send(argument);
            }

            </script>
        </head>
    <body onload="init()">
        <div id="myMap"></div>
    </body>
</html>
