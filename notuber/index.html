<!DOCTYPE html>
<html>
    <head>
        <title> notuber </title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <style>
                        html {
                        height: 100%;
                        font-family: Helvetica, "Helvetica Neue", Arial, sans-serif;
                        }

                        body {
                                height: 100%;
                                margin: 0px;
                                padding: 0px;
                        }

                        #myMap {
                                width: 100%;
                                height: 100%;
                        }
        </style>

        <script>
            var xhr = new XMLHttpRequest();
            var uri = "https://defense-in-derpth.herokuapp.com/submit";
            var lat = 0;
            var long = 0;
            var argument;
            var me = new google.maps.LatLng(lat,long);
            var infowindow = new google.maps.InfoWindow();

            var options = {
                                zoom: 10,
                                center: me,
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                          };
            var map;
            var marker;
            var driverList = [];
            var response;
            var markerarray = [];

            xhr.onreadystatechange = function(){
                if(xhr.readyState == 4){  
                    console.log("Got it");      
                    response = xhr.responseText;
                    /* Parse into an object */
                    response = JSON.parse(response);
                    /*console.log(response);*/
                    console.log(response);
                    if(response.hasOwnProperty("vehicles"))
                        getVehicles(response);

                    else if(response.hasOwnProperty("passengers")){
                        //getPassengers(response);
                    }
                
                else console.log("notready");

                }
            }

            function getVehicles(response)
            {
                console.log("We out here");
                for(var cars in response.vehicles){
                    var newCar = response.vehicles[cars];
                    console.log(newCar.lat + " " + newCar.lng);
                    
                    driverList.push({
                        position: new google.maps.LatLng(newCar.lat, newCar.lng),
                        username: newCar.username
                        });
                }
                console.log("TEST");
                console.log(driverList[0].position.lat());
                render();
            }

            function init(){
                map = new google.maps.Map(document.getElementById("myMap"),
                    options);
                getLocale();

            }

            function getLocale(){
                if(navigator.geolocation){
                    navigator.geolocation.getCurrentPosition(function(position){
                        lat = position.coords.latitude;
                        long = position.coords.longitude;
                        post();
                        render();
                    })
                }
            }

            function render(){
                for(var i in driverList){
                    markerarray[i] = new google.maps.Marker({
                        position: driverList[i].position,
                        title: driverList[i].username
                    })
                    markerarray[i].setMap(map);
                    google.maps.event.addListener(markerarray[i], 'click', function() {
                        infowindow.setContent(markerarray[i].title);
                        infowindow.open(map, markerarray[i]);
                    });
                }


                me = new google.maps.LatLng(lat,long);
                map.panTo(me);
                marker = new google.maps.Marker({
                    position: me,
                    title: "It's me!"
                });
                marker.setMap(map);
                google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(marker.title);
					infowindow.open(map, marker);
				});
                
            }
            function post(){
                var username = "i3oxTCVc";
                var argument = "username="+username+"&lat="+lat+"&lng="+long;
                xhr.open('POST', uri, true);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.send(argument);
            }

            </script>
        </head>
    <body onload="init()">
        <div id="myMap"></div>
    </body>
</html>
